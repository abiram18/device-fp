<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Fingerprint with Location</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #popup {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
  </style>
</head>
<body>

<div id="overlay"></div>
<div id="popup">
  <p id="popup-message"></p>
  <button onclick="closePopup()">Close</button>
</div>

<!-- Login Form -->
<form id="loginForm">
  <label for="username">Username:</label>
  <input type="text" id="username" name="username" required>
  <label for="password">Password:</label>
  <input type="password" id="password" name="password" required>
  <button type="submit">Login</button>
</form>

<script>
  function showPopup(message) {
    document.getElementById('popup-message').innerText = message;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('popup').style.display = 'block';
  }

  function closePopup() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('popup').style.display = 'none';
  }

  function getDistanceInKm(lat1, lon1, lat2, lon2) {
    const toRad = (value) => (value * Math.PI) / 180;
    const R = 6371; // Earth's radius in km

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  async function getIP() {
    try {
      let response = await fetch("https://api64.ipify.org?format=json");
      let data = await response.json();
      return data.ip;
    } catch (error) {
      console.error("Error fetching IP:", error);
      return "Unknown";
    }
  }

  async function generateHash(obj) {
    const jsonString = JSON.stringify(obj);
    const data = new TextEncoder().encode(jsonString);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function getGeolocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject("Geolocation not supported");
      }

      navigator.geolocation.getCurrentPosition(
        position => {
          resolve({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          });
        },
        error => {
          reject(error.message);
        },
        { timeout: 5000 }
      );
    });
  }

  async function checkFingerprint() {
    try {
      const geo = await getGeolocation();
      const ip = await getIP();
      const deviceInfo = {
        userAgent: navigator.userAgent,
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        os: navigator.platform,
        ip: ip,
        location: geo
      };

      const hashInfo = { ...deviceInfo };
      delete hashInfo.location;

      const currentFingerprint = await generateHash(hashInfo);
      const storedFingerprint = localStorage.getItem("deviceFingerprint");

      if (storedFingerprint) {
        if (storedFingerprint === currentFingerprint) {
          showPopup("âœ… Trusted device. Fingerprint matches stored one.");
        } else {
          showPopup("âš ï¸ Warning: Fingerprint mismatch!");
          const storedLocation = JSON.parse(localStorage.getItem("storedLocation"));
          if (storedLocation) {
            const dist = getDistanceInKm(
                storedLocation.latitude, storedLocation.longitude,
                geo.latitude, geo.longitude
            );
            console.log("Distance from saved location:", dist.toFixed(2), "km");

            if (dist > 100) {                                                                              
                showPopup("âš ï¸ You are logging in from a new location! (" + dist.toFixed(2) + " km away)"); //CHANGE DISTANCE RADIUS
            }
          }
        }
      } else {
        localStorage.setItem("deviceFingerprint", currentFingerprint);
        showPopup("ðŸ†• First-time visitor. Fingerprint saved.");
        localStorage.setItem("storedLocation", JSON.stringify(geo));
      }
    } catch (error) {
      showPopup("âŒ Location access denied. Entry restricted.");
    }
  }

  // Login form submission
  const loginForm = document.getElementById("loginForm");
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    // Submit login info and fingerprint data
    try {
      const geo = await getGeolocation();
      const ip = await getIP();
      const deviceInfo = {
        userAgent: navigator.userAgent,
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        os: navigator.platform,
        ip: ip,
        location: geo
      };

      const hashInfo = { ...deviceInfo };
      delete hashInfo.location;
      const currentFingerprint = await generateHash(hashInfo);

      fetch("https://device-fp.onrender.com/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
        username,
        password, // âœ… include password here
        timestamp: new Date().toISOString(),
        fingerprint: currentFingerprint,
        deviceInfo
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message);
        } else {
          localStorage.setItem("isLoggedIn", "true");
          window.location.href = "/"; // Redirect to the main page after login
        }
      })
      .catch(error => console.log("Error:", error));
    } catch (error) {
      console.log("Error in fingerprint generation:", error);
    }
  });

  // ðŸ‘‡ Check for login token in URL
  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("auth") !== "1") {
      window.location.href = "login.html"; // redirect to login
    } else {
      checkFingerprint(); // continue fingerprint check
    }
  };
</script>

</body>
</html>